<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <title>VaultLeakX Pro | Enterprise Cronos Intelligence</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
</head>
<body class="bg-[#0b0f14] text-white font-['Inter']">
  <!-- Bottom Settings Panel (Mobile) -->
  <div id="settingsPanel" class="fixed bottom-0 left-0 right-0 bg-[#111827] border-t border-gray-800 p-4 transform translate-y-full transition-transform duration-300 z-50 rounded-t-xl md:hidden">
    <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
    <div class="space-y-4">
      <h2 class="text-lime-300 font-semibold">Settings</h2>
      <div class="grid grid-cols-2 gap-3">
        <label class="flex items-center space-x-2 text-sm">
          <input type="checkbox" id="soundAlerts" checked>
          <span>Sound Alerts</span>
        </label>
        <label class="flex items-center space-x-2 text-sm">
          <input type="checkbox" id="autoScroll" checked>
          <span>Auto-scroll</span>
        </label>
        <label class="flex items-center space-x-2 text-sm">
          <input type="checkbox" id="darkMode" checked>
          <span>Dark Mode</span>
        </label>
      </div>
      <div class="filter-group mt-4">
        <h2 class="text-lime-300 font-semibold mb-2">Transaction Filters</h2>
        <div class="grid grid-cols-2 gap-2">
          <label class="filter-item"><input type="checkbox" id="deploys" checked><span>Deploys</span></label>
          <label class="filter-item"><input type="checkbox" id="whales" checked><span>Whales</span></label>
          <label class="filter-item"><input type="checkbox" id="mid" checked><span>Mid</span></label>
          <label class="filter-item"><input type="checkbox" id="small" checked><span>Small</span></label>
          <label class="filter-item"><input type="checkbox" id="gas" checked><span>Gas</span></label>
          <label class="filter-item"><input type="checkbox" id="dex" checked><span>DEX</span></label>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="flex flex-col h-screen">
    <!-- Header -->
    <header class="px-4 py-3 bg-[#0f172a] border-b border-lime-400/50 backdrop-blur-sm sticky top-0 z-40">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
          <div class="relative">
            <h1 class="text-lg font-['Orbitron'] tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-lime-400 to-emerald-400">VAULTLEAKX‚Ä¢PRO</h1>
            <div class="absolute -top-1 -right-2 w-2 h-2 bg-lime-400 rounded-full animate-ping"></div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="toggleSettings" class="text-lime-400 text-sm">
            ‚öôÔ∏è
          </button>
        </div>
      </div>
      
      <div class="mt-2 flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
        <div class="stats-pill whitespace-nowrap"><span class="text-gray-400">CHAIN:</span> <span class="text-emerald-400">CRONOS</span></div>
        <div class="stats-pill whitespace-nowrap"><span class="text-gray-400">BLOCKS:</span> <span id="blockNumber" class="text-white">-</span></div>
        <div class="stats-pill whitespace-nowrap"><span class="text-gray-400">TXs:</span> <span id="txCount" class="text-white">0</span></div>
        <div id="connectionStatus" class="stats-pill whitespace-nowrap"><span class="animate-pulse text-lime-500">‚óè</span> LIVE</div>
      </div>

      <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
        <div class="stat-card">
          <div class="text-gray-400">24h Vol</div>
          <div class="text-sm font-bold text-white" id="totalVolume">0 CRO</div>
        </div>
        <div class="stat-card">
          <div class="text-gray-400">Gas</div>
          <div class="text-sm font-bold text-white" id="avgGas">0</div>
        </div>
      </div>
    </header>

    <!-- Feed Viewer -->
    <main class="flex-1 overflow-y-auto p-3 space-y-3" id="feed"></main>
  </div>

<style>
  html { 
    background-color: #0b0f14; 
  }
  
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  .stats-pill {
    @apply px-3 py-1 bg-black/30 rounded-full border border-gray-800 text-xs backdrop-blur-sm;
  }

  .stat-card {
    @apply p-3 bg-black/30 rounded-lg border border-gray-800/50 backdrop-blur-sm;
  }

  .filter-item {
    @apply flex items-center space-x-2 text-sm cursor-pointer hover:text-lime-400 transition-colors;
  }

  .event {
    @apply p-4 rounded-lg border border-gray-800/50 bg-black/30 backdrop-blur-sm;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .badge {
    @apply text-[10px] px-2 py-0.5 rounded-full inline-flex items-center gap-1;
    white-space: nowrap;
  }

  .badge.deploy { @apply bg-yellow-500/20 text-yellow-400; }
  .badge.whale { @apply bg-emerald-500/20 text-emerald-400; }
  .badge.mid { @apply bg-pink-500/20 text-pink-400; }
  .badge.small { @apply bg-gray-500/20 text-gray-400; }
  .badge.gas { @apply bg-red-500/20 text-red-400; }
  .badge.dex { @apply bg-purple-500/20 text-purple-400; }
  .badge.buy { @apply bg-green-500/20 text-green-400; }
  .badge.sell { @apply bg-red-500/20 text-red-400; }

  .token-logo {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
    vertical-align: middle;
    margin-right: 4px;
    background: rgba(255,255,255,0.1);
  }
</style>

<script>
const CONFIG = {
  MAX_EVENTS: 100,
  WHALE_THRESHOLD: 1000,
  MID_THRESHOLD: 100,
  GAS_SPIKE_THRESHOLD: 100
};

const knownRouters = {
  "0x145677fc4d9b8f19b5d56d1820c48e0443049a30": "CronaSwap",
  "0x5ae401dcf3f8b7786d0562ea84b6f572a3b5e5d9": "VVS Finance",
  "0x22ccb916b6f66d823eeab45f36cdde4fbb9a35ca": "MM Finance",
  "0x5c4af5a3102641cf4c7322a1d8e7896b3aea1d3c": "CorgiSwap"
};

let settingsPanelVisible = false;
const provider = new ethers.providers.JsonRpcProvider("https://evm.cronos.org");
const feed = document.getElementById("feed");
const txCount = document.getElementById("txCount");
const settingsPanel = document.getElementById("settingsPanel");

document.getElementById("toggleSettings").addEventListener("click", () => {
  settingsPanelVisible = !settingsPanelVisible;
  settingsPanel.style.transform = settingsPanelVisible ? "translateY(0)" : "translateY(100%)";
});

// Touch handling for settings panel
let touchStartY = 0;
let touchMoveY = 0;

settingsPanel.addEventListener("touchstart", (e) => {
  touchStartY = e.touches[0].clientY;
});

settingsPanel.addEventListener("touchmove", (e) => {
  touchMoveY = e.touches[0].clientY;
  const delta = touchMoveY - touchStartY;
  if (delta > 0) { // Only allow dragging down
    settingsPanel.style.transform = `translateY(${delta}px)`;
    e.preventDefault();
  }
});

settingsPanel.addEventListener("touchend", () => {
  const delta = touchMoveY - touchStartY;
  if (delta > 70) { // If dragged down more than 70px, close the panel
    settingsPanel.style.transform = "translateY(100%)";
    settingsPanelVisible = false;
  } else {
    settingsPanel.style.transform = "translateY(0)";
  }
});

const state = {
  gasHistory: [],
  stats: {
    totalVolume: 0,
    whaleCount: 0,
    dexVolume: 0,
    deployCount: 0,
    midCount: 0,
    smallCount: 0,
    gasCount: 0,
    dexCount: 0
  }
};

const formatAddr = (addr) => `${addr.slice(0, 6)}...${addr.slice(-4)}`;

const getTokenLogo = async (addr) => {
  try {
    const res = await fetch(`https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/cronos/assets/${addr}/logo.png`);
    if (res.ok) {
      return res.url;
    }
  } catch (e) {}
  return null;
};

const playAlert = (hz, type) => {
  if (!soundAlerts?.checked) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = type;
  osc.frequency.value = hz;
  gain.gain.value = 0.1;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
  osc.stop(ctx.currentTime + 0.5);
};

const renderEvent = async (label, tx, { tags }) => {
  const el = document.createElement("div");
  el.className = "event";

  let tokenLogo = "";
  if (tx.to) {
    const logoUrl = await getTokenLogo(tx.to);
    if (logoUrl) {
      tokenLogo = `<img src="${logoUrl}" alt="token" class="token-logo" onerror="this.style.display='none'">`;
    }
  }

  const value = parseFloat(ethers.utils.formatEther(tx.value)).toFixed(2);
  const isBuy = tx.value.gt(0);

  el.innerHTML = `
    <div class="text-xs flex items-center justify-between">
      <div class="font-semibold text-lime-400 flex items-center">
        ${tokenLogo}${label}
      </div>
      <a href="https://cronoscan.com/tx/${tx.hash}" target="_blank" class="text-emerald-400 hover:underline">View ‚Üó</a>
    </div>
    <div class="text-xs mt-2">
      <div class="flex justify-between">
        <span>From: <span class="text-white">${formatAddr(tx.from)}</span></span>
        <span class="badge ${isBuy ? 'buy' : 'sell'}">${isBuy ? 'üü¢ BUY' : 'üî¥ SELL'}</span>
      </div>
      <div>To: <span class="text-white">${formatAddr(tx.to || "")}</span></div>
      <div>Value: <span class="text-white">${value} CRO</span></div>
    </div>
    <div class="mt-2 flex flex-wrap gap-1">${tags}</div>
  `;

  feed.prepend(el);
  if (autoScroll?.checked) feed.scrollTop = 0;
  if (feed.childElementCount > CONFIG.MAX_EVENTS) {
    feed.removeChild(feed.lastChild);
  }
};

const statsUpdate = () => {
  document.getElementById("totalVolume").textContent = `${state.stats.totalVolume.toFixed(2)} CRO`;
  document.getElementById("avgGas").textContent = (
    state.gasHistory.reduce((a, b) => a + b, 0) / state.gasHistory.length || 0
  ).toFixed(1);
};

provider.on("block", async (blockNumber) => {
  document.getElementById("blockNumber").textContent = blockNumber;

  const filters = {
    deploys: deploys?.checked,
    whales: whales?.checked,
    mid: mid?.checked,
    small: small?.checked,
    gas: gas?.checked,
    dex: dex?.checked
  };

  try {
    const block = await provider.getBlockWithTransactions(blockNumber);
    for (const tx of block.transactions) {
      const val = parseFloat(ethers.utils.formatEther(tx.value || 0));
      const gasPrice = parseFloat(ethers.utils.formatUnits(tx.gasPrice, "gwei") || 0);
      const to = tx.to?.toLowerCase() || "";
      let tags = "";

      state.gasHistory.push(gasPrice);
      if (state.gasHistory.length > 100) state.gasHistory.shift();
      txCount.textContent = (+txCount.textContent + 1).toString();

      if (!tx.to && filters.deploys) {
        state.stats.deployCount++;
        tags += `<span class="badge deploy">üöÄ Deploy</span>`;
        playAlert(400, "triangle");
        await renderEvent("Contract Deploy", tx, { tags });
        continue;
      }

      if (val >= CONFIG.WHALE_THRESHOLD && filters.whales) {
        state.stats.totalVolume += val;
        state.stats.whaleCount++;
        tags += `<span class="badge whale">ü¶à Whale</span>`;
        playAlert(600, "square");
        await renderEvent("Whale Transfer", tx, { tags });
      } else if (val >= CONFIG.MID_THRESHOLD && val < CONFIG.WHALE_THRESHOLD && filters.mid) {
        state.stats.totalVolume += val;
        state.stats.midCount++;
        tags += `<span class="badge mid">üêü Mid</span>`;
        await renderEvent("Mid Transfer", tx, { tags });
      } else if (val > 0 && val < CONFIG.MID_THRESHOLD && filters.small) {
        state.stats.totalVolume += val;
        state.stats.smallCount++;
        tags += `<span class="badge small">ü™ô Small</span>`;
        await renderEvent("Small Transfer", tx, { tags });
      }

      if (gasPrice > CONFIG.GAS_SPIKE_THRESHOLD && filters.gas) {
        state.stats.gasCount++;
        tags += `<span class="badge gas">üî• ${gasPrice.toFixed(1)} Gwei</span>`;
        playAlert(200, "sawtooth");
        await renderEvent("Gas Spike", tx, { tags });
      }

      if (filters.dex && knownRouters[to]) {
        state.stats.dexCount++;
        state.stats.dexVolume += val;
        tags += `<span class="badge dex">üí± ${knownRouters[to]}</span>`;
        await renderEvent("DEX Trade", tx, { tags });
      }

      statsUpdate();
    }
  } catch (err) {
    document.getElementById("connectionStatus").innerHTML = '<span class="text-red-500">‚óè</span> ERROR';
    console.error(err);
  }
});

// Restore settings
const saved = JSON.parse(localStorage.getItem("vaultleakx-settings") || "{}");
if ('soundAlerts' in saved) soundAlerts.checked = saved.soundAlerts;
if ('autoScroll' in saved) autoScroll.checked = saved.autoScroll;
if ('darkMode' in saved) darkMode.checked = saved.darkMode;

// Watch for setting changes
document.querySelectorAll("input[type=checkbox]").forEach(cb => {
  cb.addEventListener("change", () => {
    const newSettings = {
      soundAlerts: soundAlerts.checked,
      autoScroll: autoScroll.checked,
      darkMode: darkMode.checked
    };
    localStorage.setItem("vaultleakx-settings", JSON.stringify(newSettings));
  });
});
</script>
</body>
</html>

